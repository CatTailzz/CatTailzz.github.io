---
title: 使用K8sJavaClient监控配置文件，实现自动化部署
subtitle: 
date: 2024-07-23T16:16:16+08:00
slug: "8100467"
draft: true
tags:
  - K8s
  - DevOps
categories:
  - DevOps
password: 
message:
---
# 需求背景

在过去，公司在部署服务时需要在多个环节手动修改配置和部署，特别是对于基础产品Starter和一系列能力包（abcd）的组合。这种手动操作不仅繁琐，还容易出错，严重影响了工作效率和部署的可靠性。

为了解决这些问题并提升部署效率，我们决定引入DevOps实践，实现自动化部署。我们从一个源头配置文件入手，通过监控最上游文件的变更，实现整条链路的自动化配置变更和服务部署。

一个比较小的需求，正好可以熟悉一下DevOps的思想和部分实践。

# 实现计划

## 分析

由于整个任务是围绕着 K8s 服务来的，对比以往的手动操作，现在要做的就是把以前的操作包装并自动化，我们考虑使用 K8s 为 Java 提供的 client 来实现，把整个任务作为一个 pod 部署。

为了和原本的服务 pod 区分，我们管自己的任务叫 monitor pod，原本服务叫 
service pod。

## 如何监控源配置文件

监控文件变更有多种方式，最简单的可以把解析文件的过程写入 init 方法，然后在变更文件的同时去重启一下 monitor pod ，重新执行 init 方法。

要进一步自动化，我们可以在部署 monitor pod 时，用 Java 的 `WatchService` 监控文件，或者用 Linux 内核提供的 `inotify` 来监控，但综合对比了风险、复杂度和资源消耗等，还是选择了简单的手动重启 pod 

## 如何变更下游服务

